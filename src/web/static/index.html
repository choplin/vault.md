<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vault.md</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.css" rel="stylesheet" type="text/css" />
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html@3.4.45/bundles/css/diff2html.min.css">
  <script src="https://cdn.jsdelivr.net/npm/diff2html@3.4.45/bundles/js/diff2html-ui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Prism.js for syntax highlighting -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css">
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
  <style>
    /* Customize code block styling */
    .prose pre[class*="language-"] {
      background-color: hsl(var(--b2));
      border: 1px solid hsl(var(--b3));
      border-radius: 0.5rem;
    }
    .prose code[class*="language-"] {
      background-color: transparent;
    }
    /* Inline code styling */
    .prose :not(pre) > code {
      background-color: hsl(var(--b2));
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-weight: normal;
    }
  </style>
</head>

<body class="bg-base-200" x-data="vaultApp()" data-theme="light">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <div class="w-80 bg-base-100 border-r border-base-300 overflow-y-auto">
      <div class="p-4 border-b border-base-200">
        <h1 class="text-xl font-semibold text-base-content flex items-center gap-2">
          <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
          </svg>
          vault.md
        </h1>
        <p class="text-sm text-base-content/60 mt-1">Knowledge vault for AI development</p>
      </div>

      <!-- Loading State -->
      <div x-show="loading" class="flex justify-center items-center p-8">
        <span class="loading loading-spinner loading-md"></span>
      </div>

      <!-- Tree View -->
      <div x-show="!loading" class="px-2 pb-4">
        <!-- Current Project Section -->
        <template x-if="projects.find(p => p.isCurrentProject)">
          <div>
            <div class="text-xs font-semibold text-base-content/60 uppercase tracking-wider px-3 py-2">
              Current Project
            </div>
            <template x-for="project in projects.filter(p => p.isCurrentProject)" :key="project.path">
              <div class="mb-3">
                <button @click="project.open = !project.open" class="btn btn-ghost btn-sm w-full justify-start normal-case py-2">
                  <svg class="w-4 h-4 mr-2 transition-transform text-base-content/40" :class="{'rotate-90': project.open}"
                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                  <svg class="w-4 h-4 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                  </svg>
                  <span class="font-medium text-base-content truncate" x-text="project.name"></span>
                  <span class="ml-auto badge badge-sm badge-primary" x-text="project.entries.length"></span>
                </button>

                <div x-show="project.open" x-transition class="ml-5 mt-1">
                  <template x-for="entry in project.entries" :key="entry.key">
                    <div class="w-full mb-1">
                      <button @click="selectEntry(project.path, entry.key)"
                        class="btn btn-ghost btn-sm w-full justify-start ml-4 normal-case py-2"
                        :class="{'btn-active': selectedKey === entry.key}">
                        <svg class="w-4 h-4 mr-2"
                          :class="selectedKey === entry.key ? 'text-primary' : 'text-base-content/40'" fill="none"
                          stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                          </path>
                        </svg>
                        <div class="flex-1 min-w-0 text-left">
                          <span class="text-base-content font-medium" x-text="entry.key"></span>
                          <p class="text-xs text-base-content/60 truncate" x-show="entry.description"
                            x-text="entry.description"></p>
                        </div>
                        <span class="ml-2 text-xs opacity-60 flex-shrink-0">
                          v<span x-text="entry.version"></span>
                        </span>
                      </button>
                    </div>
                  </template>
                </div>
              </div>
            </template>
          </div>
        </template>

        <!-- Other Projects Section -->
        <template x-if="projects.filter(p => !p.isCurrentProject).length > 0">
          <div class="mt-4">
            <div class="text-xs font-semibold text-base-content/60 uppercase tracking-wider px-3 py-2">
              Other Projects
            </div>
            <template x-for="project in projects.filter(p => !p.isCurrentProject)" :key="project.path">
              <div class="mb-3">
                <button @click="project.open = !project.open" class="btn btn-ghost btn-sm w-full justify-start normal-case py-2">
                  <svg class="w-4 h-4 mr-2 transition-transform text-base-content/40" :class="{'rotate-90': project.open}"
                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                  <svg class="w-4 h-4 mr-2 text-base-content/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                  </svg>
                  <span class="font-medium text-base-content truncate" x-text="project.name"></span>
                  <span class="ml-auto badge badge-sm badge-ghost" x-text="project.entries.length"></span>
                </button>

                <div x-show="project.open" x-transition class="ml-5 mt-1">
                  <template x-for="entry in project.entries" :key="entry.key">
                    <div class="w-full mb-1">
                      <button @click="selectEntry(project.path, entry.key)"
                        class="btn btn-ghost btn-sm w-full justify-start ml-4 normal-case py-2"
                        :class="{'btn-active': selectedKey === entry.key}">
                        <svg class="w-4 h-4 mr-2"
                          :class="selectedKey === entry.key ? 'text-primary' : 'text-base-content/40'" fill="none"
                          stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                          </path>
                        </svg>
                        <div class="flex-1 min-w-0 text-left">
                          <span class="text-base-content font-medium" x-text="entry.key"></span>
                          <p class="text-xs text-base-content/60 truncate" x-show="entry.description"
                            x-text="entry.description"></p>
                        </div>
                        <span class="ml-2 text-xs opacity-60 flex-shrink-0">
                          v<span x-text="entry.version"></span>
                        </span>
                      </button>
                    </div>
                  </template>
                </div>
              </div>
            </template>
          </div>
        </template>
      </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col">
      <!-- Content Header -->
      <div x-show="selectedKey" class="bg-base-100 border-b border-base-200 px-8 py-4">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-xl font-semibold text-base-content" x-text="selectedKey"></h2>
            <p class="text-sm text-base-content/60 mt-1">
              <span x-text="selectedProject?.split('/').pop()"></span> â€¢ Version <span
                x-text="selectedVersion || 'latest'"></span>
            </p>
          </div>
          <div class="flex gap-2">
            <button class="btn btn-sm btn-ghost flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                </path>
              </svg>
              Edit
            </button>
          </div>
        </div>
      </div>

      <!-- Content Area -->
      <div class="flex-1 p-8 overflow-y-auto">
        <div class="max-w-4xl mx-auto">
          <!-- Error State -->
          <div x-show="error" class="alert alert-error mb-4">
            <span x-text="error"></span>
          </div>

          <!-- Content -->
          <div x-show="!contentLoading && content" class="card bg-base-100 shadow-xl">
            <div class="card-body">
              <article class="prose prose-lg max-w-none prose-pre:bg-base-200" x-html="renderedContent"></article>
            </div>
          </div>

          <!-- Loading Content -->
          <div x-show="contentLoading" class="flex items-center justify-center py-12">
            <div class="text-center">
              <span class="loading loading-spinner loading-lg text-primary"></span>
              <p class="text-base-content/60 mt-4">Loading content...</p>
            </div>
          </div>

          <!-- Empty State -->
          <div x-show="!contentLoading && !content && !error && !selectedKey" class="hero min-h-[50vh]">
            <div class="hero-content text-center">
              <div>
                <svg class="w-16 h-16 mx-auto mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                  </path>
                </svg>
                <h1 class="text-2xl font-bold">No entry selected</h1>
                <p class="py-6">Select an entry from the sidebar to view its content.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function vaultApp() {
        return {
          // State
          loading: true,
          contentLoading: false,
          error: null,
          projects: [],
          selectedKey: null,
          selectedProject: null,
          selectedVersion: null,
          content: null,
          renderedContent: '',
          currentProject: null,

          // Initialize
          async init() {
            // Get current project path
            const response = await fetch('/api/current-project');
            if (response.ok) {
              const data = await response.json();
              this.currentProject = data.project;
            }
            await this.loadEntries();
          },

          // Load all entries
          async loadEntries() {
            try {
              this.loading = true;
              this.error = null;

              // Always load all entries
              const response = await fetch('/api/entries/all');
              if (!response.ok) throw new Error('Failed to load entries');

              const data = await response.json();

              // Group by project
              const grouped = data.reduce((acc, entry) => {
                if (!acc[entry.project]) {
                  acc[entry.project] = {
                    path: entry.project,
                    name: entry.project.split('/').pop(),
                    open: false,
                    entries: [],
                    isCurrentProject: false
                  };
                }

                // Only show latest version of each key
                const existing = acc[entry.project].entries.find(e => e.key === entry.key);
                if (!existing || existing.version < entry.version) {
                  if (existing) {
                    acc[entry.project].entries = acc[entry.project].entries.filter(e => e.key !== entry.key);
                  }
                  acc[entry.project].entries.push({
                    key: entry.key,
                    version: entry.version,
                    description: entry.description
                  });
                }

                return acc;
              }, {});

              // Sort projects: current project first, then others
              const projectsArray = Object.values(grouped);
              const currentProjectData = projectsArray.find(p => p.path === this.currentProject);
              const otherProjects = projectsArray.filter(p => p.path !== this.currentProject);
              
              this.projects = [];
              if (currentProjectData) {
                this.projects.push({
                  ...currentProjectData,
                  isCurrentProject: true
                });
              }
              if (otherProjects.length > 0) {
                this.projects.push(...otherProjects.map(p => ({
                  ...p,
                  isCurrentProject: false
                })));
              }
            } catch (err) {
              this.error = err.message;
            } finally {
              this.loading = false;
            }
          },

          // Select and load entry content
          async selectEntry(project, key) {
            try {
              this.contentLoading = true;
              this.error = null;
              this.selectedKey = key;
              this.selectedProject = project;
              this.selectedVersion = null;

              const response = await fetch(`/api/entry/${encodeURIComponent(project)}/${encodeURIComponent(key)}`);
              if (!response.ok) throw new Error('Failed to load content');

              const data = await response.json();
              this.content = data.content;

              // Render markdown
              this.renderedContent = marked.parse(this.content);

              // Apply syntax highlighting after DOM update
              this.$nextTick(() => {
                Prism.highlightAll();
              });
            } catch (err) {
              this.error = err.message;
              this.content = null;
            } finally {
              this.contentLoading = false;
            }
          },

          // Load specific version
          async loadVersion(project, key, version) {
            try {
              this.contentLoading = true;
              this.error = null;

              const response = await fetch(`/api/entry/${encodeURIComponent(project)}/${encodeURIComponent(key)}/${version}`);
              if (!response.ok) throw new Error('Failed to load version');

              const data = await response.json();
              this.content = data.content;
              this.renderedContent = marked.parse(this.content);
            } catch (err) {
              this.error = err.message;
            } finally {
              this.contentLoading = false;
            }
          }
        }
      }
    </script>
</body>

</html>
